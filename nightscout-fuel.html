<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nightscout Fuel Helper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-main: #000;
      --card-bg: #111;
      --card-border: #333;
      --text-main: #eee;
      --accent: #0a84ff;
      --low: #003f8c;
      --near-low: #005b99;
      --sweet: #004d40;
      --high: #7b3f00;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 0.7rem;
      background: var(--bg-main);
      color: var(--text-main);
    }

    h1 {
      font-size: 1.1rem;
      margin: 0;
      text-align: center;
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      gap: 0.4rem;
    }

    .top-bar h1 {
      flex: 1;
      text-align: center;
    }

    .icon-btn {
      border: none;
      border-radius: 999px;
      background: #222;
      color: #ccc;
      width: 2.1rem;
      height: 2.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      padding: 0;
    }

    .icon-btn:active {
      background: #444;
    }

    .card {
      border-radius: 0.7rem;
      padding: 0.6rem;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      margin-bottom: 0.45rem;
    }

    .bg-strip {
      border-radius: 0.7rem;
      padding: 0.6rem;
      margin-bottom: 0.5rem;
      text-align: center;
    }

    .bg-value {
      font-size: 2.1rem;
      font-weight: 800;
      margin-bottom: 0.1rem;
    }

    .bg-sub {
      font-size: 0.9rem;
      opacity: 0.85;
    }

    .main-text {
      font-size: 1.4rem;
      text-align: center;
      margin: 0.2rem 0 0.1rem;
      font-weight: 700;
    }

    .sub-text {
      text-align: center;
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 0.1rem;
    }

    .status-text {
      text-align: center;
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .row {
      display: flex;
      gap: 0.3rem;
      align-items: center;
    }

    .row + .row {
      margin-top: 0.25rem;
    }

    .row > div {
      flex: 1;
    }

    label {
      font-size: 0.75rem;
      opacity: 0.8;
      display: block;
      margin-bottom: 0.15rem;
    }

    input {
      width: 100%;
      padding: 0.35rem;
      border-radius: 0.4rem;
      border: none;
      font-size: 0.9rem;
      box-sizing: border-box;
      background: #222;
      color: #eee;
    }

    .mode-toggle {
      display: flex;
      border-radius: 999px;
      background: #222;
      padding: 0.12rem;
      font-size: 0.85rem;
    }

    .mode-btn {
      flex: 1;
      border: none;
      border-radius: 999px;
      padding: 0.25rem 0.3rem;
      background: transparent;
      color: #aaa;
    }

    .mode-btn.active {
      background: var(--accent);
      color: #fff;
      font-weight: 600;
    }

    .zone-buttons {
      display: flex;
      gap: 0.3rem;
      margin-top: 0.35rem;
    }

    .zone-btn {
      flex: 1;
      border: none;
      border-radius: 0.55rem;
      padding: 0.45rem 0;
      background: #222;
      color: #ccc;
      font-size: 1rem;
      font-weight: 700;
    }

    .zone-btn.active {
      background: var(--accent);
      color: #fff;
    }

    .tiny {
      font-size: 0.7rem;
      opacity: 0.7;
      margin-top: 0.15rem;
      text-align: center;
    }

    .timer-row {
      display: flex;
      gap: 0.4rem;
      margin-top: 0.3rem;
    }

    .timer-row button {
      border: none;
      border-radius: 0.55rem;
      padding: 0.4rem;
      background: #222;
      color: #eee;
      font-size: 0.9rem;
      flex: 1;
    }

    .timer-row button:active {
      background: #444;
    }

    .settings-panel {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease;
    }

    .settings-panel.open {
      max-height: 400px;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <button class="icon-btn" id="refreshBtn">⭮</button>
    <h1>Fuel Helper</h1>
    <button class="icon-btn" id="settingsToggle">⚙︎</button>
  </div>

  <!-- BG strip with color coding -->
  <div id="bgStrip" class="bg-strip" style="background:#222;">
    <div id="bgValue" class="bg-value">--.--</div>
    <div id="bgSub" class="bg-sub">Waiting for CGM…</div>
  </div>

  <!-- Main fueling summary -->
  <div class="card">
    <div id="feedMain" class="main-text">Set zone to begin</div>
    <div id="feedSub" class="sub-text"></div>
    <div id="projLine" class="sub-text"></div>
    <div id="statusLine" class="status-text">Nightscout: idle</div>
  </div>

  <!-- Zone + timer card -->
  <div class="card">
    <div id="zoneLine" class="sub-text">Zone --</div>

    <div class="zone-buttons">
      <button class="zone-btn" data-zone="1">Z1</button>
      <button class="zone-btn" data-zone="2">Z2</button>
      <button class="zone-btn" data-zone="3">Z3</button>
      <button class="zone-btn" data-zone="4">Z4</button>
      <button class="zone-btn" data-zone="5">Z5</button>
    </div>

    <div class="timer-row">
      <button id="logFeedBtn">Log feed now</button>
      <button id="resetTimerBtn">Reset timer</button>
    </div>
    <div class="tiny" id="timerLine">No feed logged yet</div>
  </div>

  <!-- Slide-down settings -->
  <div class="card settings-panel" id="settingsPanel">
    <div class="row">
      <div>
        <label for="ftpInput">FTP (watts)</label>
        <input id="ftpInput" type="number" inputmode="numeric" value="305" />
      </div>
      <div>
        <label>BG units</label>
        <button id="unitToggle" class="mode-btn active" style="width:100%; border-radius:0.4rem;">mmol/L</button>
      </div>
    </div>

    <div style="margin-top:0.4rem;">
      <label>Mode</label>
      <div class="mode-toggle">
        <button class="mode-btn active" data-mode="training" id="modeTraining">Training</button>
        <button class="mode-btn" data-mode="race" id="modeRace">Race</button>
      </div>
    </div>

    <div style="margin-top:0.4rem;">
      <label>Carbs per 20 min by zone</label>
      <div class="row">
        <div>
          <label for="carbZ1">Z1</label>
          <input id="carbZ1" type="number" />
        </div>
        <div>
          <label for="carbZ2">Z2</label>
          <input id="carbZ2" type="number" />
        </div>
        <div>
          <label for="carbZ3">Z3</label>
          <input id="carbZ3" type="number" />
        </div>
        <div>
          <label for="carbZ4">Z4</label>
          <input id="carbZ4" type="number" />
        </div>
        <div>
          <label for="carbZ5">Z5</label>
          <input id="carbZ5" type="number" />
        </div>
      </div>
    </div>

    <div class="tiny">
      Training defaults (per 20'): Z2 ~8g, Z3 ~12g, Z4 ~18g, Z5 ~22g.  
      Race defaults are more aggressive. Tune these with your care team as needed.
    </div>
  </div>

  <script>
    // ----- CONSTANTS -----
    const NS_URL = "https://keithgarvin.us.nightscoutpro.com"; // hard-coded

    // Default carb plans (per 20 min)
    const DEFAULT_TRAINING = [0, 8, 12, 18, 22];
    const DEFAULT_RACE     = [0, 10, 20, 25, 30];

    // ----- STATE -----
    let state = {
      useMmol: true,
      mode: "training", // or "race"
      currentZone: null,
      lastBg: null,
      lastDirection: null,
      lastDateMs: null,
      lastFeedTime: null,
      projBg20_mg: null,     // projected BG in mg/dL ~20 minutes ahead
      projLowMinutes: null   // minutes until crossing 4.0 mmol/L, if at all
    };

    // ----- ELEMENTS -----
    const bgStrip = document.getElementById('bgStrip');
    const bgValue = document.getElementById('bgValue');
    const bgSub = document.getElementById('bgSub');

    const feedMain = document.getElementById('feedMain');
    const feedSub = document.getElementById('feedSub');
    const projLine = document.getElementById('projLine');
    const statusLine = document.getElementById('statusLine');
    const zoneLine = document.getElementById('zoneLine');
    const timerLine = document.getElementById('timerLine');

    const settingsPanel = document.getElementById('settingsPanel');
    const settingsToggle = document.getElementById('settingsToggle');
    const refreshBtn = document.getElementById('refreshBtn');

    const modeTrainingBtn = document.getElementById('modeTraining');
    const modeRaceBtn = document.getElementById('modeRace');
    const unitToggle = document.getElementById('unitToggle');

    const ftpInput = document.getElementById('ftpInput');
    const carbInputs = [
      document.getElementById('carbZ1'),
      document.getElementById('carbZ2'),
      document.getElementById('carbZ3'),
      document.getElementById('carbZ4'),
      document.getElementById('carbZ5')
    ];

    const zoneButtons = Array.from(document.querySelectorAll('.zone-btn'));
    const logFeedBtn = document.getElementById('logFeedBtn');
    const resetTimerBtn = document.getElementById('resetTimerBtn');

    // ----- SETTINGS STORAGE -----
    function loadSettings() {
      try {
        const saved = JSON.parse(localStorage.getItem('nsFuelSettingsV2') || '{}');

        if (saved.ftp) ftpInput.value = saved.ftp;

        if (typeof saved.useMmol === 'boolean') {
          state.useMmol = saved.useMmol;
        }
        unitToggle.textContent = state.useMmol ? 'mmol/L' : 'mg/dL';
        unitToggle.classList.toggle('active', state.useMmol);

        if (saved.mode === 'race' || saved.mode === 'training') {
          state.mode = saved.mode;
        }

        state.trainingCarbs = Array.isArray(saved.trainingCarbs) && saved.trainingCarbs.length === 5
          ? saved.trainingCarbs
          : DEFAULT_TRAINING.slice();

        state.raceCarbs = Array.isArray(saved.raceCarbs) && saved.raceCarbs.length === 5
          ? saved.raceCarbs
          : DEFAULT_RACE.slice();
      } catch (e) {
        state.trainingCarbs = DEFAULT_TRAINING.slice();
        state.raceCarbs = DEFAULT_RACE.slice();
      }

      applyModeToInputs();
      updateModeButtons();
    }

    function saveSettings() {
      const settings = {
        ftp: Number(ftpInput.value) || null,
        useMmol: state.useMmol,
        mode: state.mode,
        trainingCarbs: state.trainingCarbs,
        raceCarbs: state.raceCarbs
      };
      localStorage.setItem('nsFuelSettingsV2', JSON.stringify(settings));
    }

    function applyModeToInputs() {
      const src = state.mode === 'race' ? state.raceCarbs : state.trainingCarbs;
      src.forEach((v, idx) => {
        if (carbInputs[idx]) carbInputs[idx].value = v;
      });
    }

    function updateModeFromInputs() {
      const values = carbInputs.map(inp => Number(inp.value) || 0);
      if (state.mode === 'race') {
        state.raceCarbs = values;
      } else {
        state.trainingCarbs = values;
      }
      saveSettings();
    }

    carbInputs.forEach(inp => inp.addEventListener('change', updateModeFromInputs));
    ftpInput.addEventListener('change', saveSettings);

    // ----- UNIT TOGGLE -----
    unitToggle.addEventListener('click', () => {
      state.useMmol = !state.useMmol;
      unitToggle.textContent = state.useMmol ? 'mmol/L' : 'mg/dL';
      unitToggle.classList.toggle('active', state.useMmol);
      saveSettings();
      render();
    });

    // ----- MODE TOGGLE -----
    function setMode(mode) {
      state.mode = mode;
      updateModeButtons();
      applyModeToInputs();
      saveSettings();
      render();
    }

    function updateModeButtons() {
      if (state.mode === 'training') {
        modeTrainingBtn.classList.add('active');
        modeRaceBtn.classList.remove('active');
      } else {
        modeTrainingBtn.classList.remove('active');
        modeRaceBtn.classList.add('active');
      }
    }

    modeTrainingBtn.addEventListener('click', () => setMode('training'));
    modeRaceBtn.addEventListener('click', () => setMode('race'));

    // ----- SETTINGS PANEL -----
    settingsToggle.addEventListener('click', () => {
      settingsPanel.classList.toggle('open');
    });

    // ----- ZONES -----
    function setZone(z) {
      state.currentZone = z;
      zoneButtons.forEach(btn => {
        const bz = Number(btn.dataset.zone);
        btn.classList.toggle('active', bz === z);
      });
      render();
    }

    zoneButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const z = Number(btn.dataset.zone);
        setZone(z);
      });
    });

    // ----- NIGHTSCOUT FETCH -----
    async function fetchNightscout() {
      const base = NS_URL;
      if (!base) {
        statusLine.textContent = 'Nightscout URL not set';
        return;
      }
      const url = base.replace(/\/+$/, '') + '/api/v1/entries.json?count=4';

      statusLine.textContent = 'Refreshing from Nightscout…';

      try {
        const res = await fetch(url);
        if (!res.ok) {
          statusLine.textContent = 'Nightscout error: ' + res.status;
          return;
        }
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) {
          statusLine.textContent = 'No data from Nightscout';
          return;
        }

        const entry = data[0];
        let sgv = Number(entry.sgv);
        const direction = entry.direction || '';
        const dateMs = entry.date || entry.dateString;

        if (!Number.isFinite(sgv) || !dateMs) {
          statusLine.textContent = 'Invalid Nightscout entry';
          return;
        }

        let bgVal = sgv;
        if (state.useMmol) {
          bgVal = sgv / 18.0;
        }

        state.lastBg = bgVal;
        state.lastDirection = direction;
        state.lastDateMs = typeof dateMs === 'number' ? dateMs : Date.parse(dateMs);

        // compute projection from recent entries
        computeProjection(data);

        statusLine.textContent = 'Nightscout: OK';
        render();
      } catch (e) {
        console.log(e);
        statusLine.textContent = 'Error talking to Nightscout';
      }
    }

    refreshBtn.addEventListener('click', fetchNightscout);

    // ----- TIMING / FEED TIMER -----
    logFeedBtn.addEventListener('click', () => {
      state.lastFeedTime = Date.now();
      render();
    });

    resetTimerBtn.addEventListener('click', () => {
      state.lastFeedTime = null;
      render();
    });

    function getFeedTimerText() {
      if (!state.lastFeedTime) {
        return 'No feed logged yet';
      }
      const diffMin = (Date.now() - state.lastFeedTime) / 60000;
      const since = diffMin < 1 ? '<1 min ago' : diffMin.toFixed(1) + ' min ago';
      const remaining = Math.max(0, 20 - diffMin);
      const remText = remaining <= 0
        ? 'Ready for next scheduled feed if plan calls for it'
        : remaining.toFixed(1) + ' min until 20\' mark';
      return `Last feed: ${since} • ${remText}`;
    }

    // ----- PROJECTION LOGIC -----
    function computeProjection(entries) {
      state.projBg20_mg = null;
      state.projLowMinutes = null;

      if (!Array.isArray(entries) || entries.length < 2) {
        return;
      }

      const sorted = entries.slice().sort((a, b) => {
        const ta = a.date || Date.parse(a.dateString);
        const tb = b.date || Date.parse(b.dateString);
        return tb - ta; // newest first
      });

      const newest = sorted[0];
      const oldest = sorted[sorted.length - 1];

      const sgvNew = Number(newest.sgv);
      const sgvOld = Number(oldest.sgv);
      const tNew = newest.date || Date.parse(newest.dateString);
      const tOld = oldest.date || Date.parse(oldest.dateString);

      if (!Number.isFinite(sgvNew) || !Number.isFinite(sgvOld) || !tNew || !tOld) {
        return;
      }

      const dtMin = (tNew - tOld) / 60000;
      if (dtMin <= 0.5) {
        return;
      }

      const slopeMgPerMin = (sgvNew - sgvOld) / dtMin;

      const horizonMin = 20;
      const projMg = sgvNew + slopeMgPerMin * horizonMin;
      state.projBg20_mg = projMg;

      const lowMg = 4.0 * 18.0;
      if (slopeMgPerMin < -0.1) {
        const minutesToLow = (lowMg - sgvNew) / slopeMgPerMin; // slope < 0 → positive if crossing
        if (minutesToLow > 0 && minutesToLow < 90) {
          state.projLowMinutes = minutesToLow;
        } else {
          state.projLowMinutes = null;
        }
      } else {
        state.projLowMinutes = null;
      }
    }

    // ----- FUELING LOGIC -----
    function isFalling(dir) {
      return dir === 'FortyFiveDown' || dir === 'SingleDown';
    }
    function isFallingFast(dir) {
      return dir === 'DoubleDown';
    }
    function isRising(dir) {
      return dir === 'FortyFiveUp' || dir === 'SingleUp';
    }
    function isRisingFast(dir) {
      return dir === 'DoubleUp';
    }

    function getTrendSymbol(direction) {
      switch (direction) {
        case 'DoubleUp':      return '↑↑';
        case 'SingleUp':      return '↑';
        case 'FortyFiveUp':   return '↗';
        case 'Flat':          return '→';
        case 'FortyFiveDown': return '↘';
        case 'SingleDown':    return '↓';
        case 'DoubleDown':    return '↓↓';
        default:              return '';
      }
    }

    function getCarbsPerZone() {
      return state.mode === 'race' ? state.raceCarbs : state.trainingCarbs;
    }

    function getFeedInstruction(bg, direction, zone, carbsZ, ageMin) {
      if (bg == null || !zone) return 'Set zone to see plan';

      if (ageMin != null && ageMin > 10) {
        return 'Data old – check CGM';
      }

      const dir = direction || '';
      const base = carbsZ[zone - 1] || 0;

      if (bg < 4.0) {
        return 'LOW – follow your low treatment plan';
      }
      if (bg >= 4.0 && bg < 5.0) {
        if (isFallingFast(dir)) return 'Near low + falling fast – may need treatment soon';
        if (isFalling(dir))     return 'Near low + falling – monitor closely';
        return 'Near low – watch CGM';
      }

      if (bg >= 5.0 && bg < 6.0) {
        if (isFallingFast(dir)) {
          return `${base}+10g/20' from your plan`;
        } else if (isFalling(dir)) {
          return `${base}+5g/20' from your plan`;
        } else {
          return `${base}g/20' from your plan`;
        }
      }

      if (bg >= 6.0 && bg <= 8.0) {
        if (isRisingFast(dir)) {
          const trimmed = Math.max(0, base - 5);
          return `${trimmed}g/20' (trim for rise)`;
        }
        return `${base}g/20' (plan)`;
      }

      if (bg > 8.0 && bg <= 10.0) {
        if (isRising(dir) || isRisingFast(dir)) {
          return 'High-ish + rising – usually 0g, watch trend';
        } else if (zone >= 4) {
          return 'Hard work – maybe small carbs if agreed in your plan';
        } else {
          return 'Probably 0g right now';
        }
      }

      if (bg > 10.0) {
        return 'High – usually no carbs; follow your plan';
      }

      return '---';
    }

    function bgColor(bg) {
      if (bg == null) return '#222';
      if (bg < 4.0) return 'var(--low)';
      if (bg < 5.0) return 'var(--near-low)';
      if (bg >= 6.0 && bg <= 8.0) return 'var(--sweet)';
      if (bg > 8.0) return 'var(--high)';
      return '#222';
    }

    // ----- RENDER -----
    function render() {
      const bg = state.lastBg;
      const dir = state.lastDirection;
      const zone = state.currentZone;
      const carbsZ = getCarbsPerZone();

      // BG strip
      if (bg == null) {
        bgValue.textContent = '--.--';
        bgSub.textContent = 'Waiting for CGM…';
        bgStrip.style.background = '#222';
      } else {
        const sym = getTrendSymbol(dir);
        if (state.useMmol) {
          bgValue.textContent = bg.toFixed(1) + ' ' + sym;
          bgSub.textContent = 'mmol/L';
        } else {
          bgValue.textContent = bg.toFixed(0) + ' ' + sym;
          bgSub.textContent = 'mg/dL';
        }
        bgStrip.style.background = bgColor(bg);
      }

      // Zone line
      if (!zone) {
        zoneLine.textContent = 'Zone --';
      } else {
        const ftp = Number(ftpInput.value) || null;
        let zoneTxt = 'Zone ' + zone;
        if (ftp) {
          const pctRanges = [
            [0, 0.55],
            [0.55, 0.75],
            [0.75, 0.90],
            [0.90, 1.05],
            [1.05, 1.20]
          ];
          const r = pctRanges[zone - 1] || null;
          if (r) {
            const low = Math.round(ftp * r[0]);
            const high = Math.round(ftp * r[1]);
            zoneTxt += ` (~${low}-${high}W)`;
          }
        }
        zoneLine.textContent = zoneTxt + ` • ${state.mode === 'race' ? 'Race' : 'Training'} plan`;
      }

      // CGM age
      let ageMin = null;
      if (state.lastDateMs) {
        const ageMs = Date.now() - state.lastDateMs;
        ageMin = ageMs / 60000;
        const ageStr = ageMin < 1 ? '<1 min ago' : ageMin.toFixed(1) + ' min ago';
        feedSub.textContent = 'Last CGM: ' + ageStr;
      } else {
        feedSub.textContent = '';
      }

      // Feed suggestion
      const feedText = getFeedInstruction(bg, dir, zone, carbsZ, ageMin);
      feedMain.textContent = feedText;

      // Projection line
      let projTxt = '';
      if (state.projBg20_mg != null && state.lastBg != null) {
        const projVal = state.useMmol
          ? state.projBg20_mg / 18.0
          : state.projBg20_mg;

        const projStr = state.useMmol
          ? projVal.toFixed(1) + ' mmol/L'
          : projVal.toFixed(0) + ' mg/dL';

        projTxt = `Proj ~20': ${projStr}`;

        if (state.projLowMinutes != null && state.projLowMinutes > 0) {
          const mins = state.projLowMinutes;
          const minsStr = mins < 1 ? '<1 min' : mins.toFixed(0) + ' min';
          projTxt += ` • Possible <4 in ~${minsStr} if trend continues (for awareness only)`;
        }
      } else {
        projTxt = '';
      }
      projLine.textContent = projTxt;

      // Timer text
      timerLine.textContent = getFeedTimerText();
    }

    // ----- INIT -----
    loadSettings();
    render();
    fetchNightscout();
    setInterval(fetchNightscout, 60000); // poll every minute
    setInterval(render, 15000);          // keep timer/projection display fresh
  </script>
</body>
</html>
