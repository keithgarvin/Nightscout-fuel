<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Fuel Helper</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg-main:#000;
  --card-bg:#fff;
  --card-border:#333;
  --text-main:#000;
  --accent:#0a84ff;
  --red:#fd0604;
  --amber:#f6c000;
  --green:#4af51a;
  --neutral:#ffffff;
}

body{
  margin:0;
  padding:0.7rem;
  background:var(--bg-main);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  color:var(--text-main);
}

h1{font-size:1.1rem;margin:0;text-align:center}

.top-bar{
  display:flex;
  align-items:center;
  gap:.4rem;
  margin-bottom:.5rem;
}
.top-bar h1{flex:1}

.icon-btn{
  width:2.1rem;height:2.1rem;
  border:none;border-radius:999px;
  background:#222;color:#ccc;
  font-size:1.3rem;
}

.card{
  background:var(--card-bg);
  border:1px solid var(--card-border);
  border-radius:.7rem;
  padding:.6rem;
  margin-bottom:.45rem;
}

.bg-strip{
  border-radius:.7rem;
  padding:.6rem;
  text-align:center;
  margin-bottom:.5rem;
}

.bg-value{font-size:2.6rem;font-weight:800}
.bg-sub{font-size:1.1rem;opacity:.85}

.main-text{font-size:1.6rem;font-weight:700;text-align:center}
.sub-text{font-size:1.1rem;text-align:center;opacity:.8}
.status-text{font-size:1.1rem;text-align:center;opacity:.7}

.zone-buttons{display:flex;gap:.3rem;margin-top:.4rem}
.zone-btn{
  flex:1;
  padding:.45rem 0;
  border:none;
  border-radius:.55rem;
  background:#222;
  color:#ccc;
  font-size:1rem;
  font-weight:700;
}
.zone-btn.active{background:var(--accent);color:#fff}

.timer-row{display:flex;gap:.4rem;margin-top:.3rem}
.timer-row button{
  flex:1;
  padding:.4rem;
  background:#222;
  color:#eee;
  border:none;
  border-radius:.6rem;
}

.settings-panel{max-height:0;overflow:hidden;transition:max-height .25s}
.settings-panel.open{max-height:500px}

label{font-size:.75rem;opacity:.8}
input{
  width:100%;
  padding:.35rem;
  background:#222;
  color:#eee;
  border:none;
  border-radius:.4rem;
}

#flashOverlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,.9);
  opacity:0;
  pointer-events:none;
  z-index:9999;
}
#flashOverlay.on{opacity:1}
</style>
</head>

<body>
<div id="flashOverlay"></div>

<div class="top-bar">
  <button class="icon-btn" id="refreshBtn">⭮</button>
  <h1>Fuel Helper</h1>
  <button class="icon-btn" id="settingsToggle">⚙︎</button>
</div>

<div id="bgStrip" class="bg-strip" style="background:var(--neutral)">
  <div id="bgValue" class="bg-value">--.--</div>
  <div id="bgSub" class="bg-sub">Waiting for CGM…</div>
</div>

<div class="card">
  <div id="feedMain" class="main-text">Set zone to begin</div>
  <div id="feedSub" class="sub-text"></div>
  <div id="projLine" class="sub-text"></div>
  <div id="statusLine" class="status-text">Nightscout: idle</div>
</div>

<div class="card">
  <div id="zoneLine" class="sub-text">Zone --</div>
  <div class="zone-buttons">
    <button class="zone-btn" data-zone="1">Z1</button>
    <button class="zone-btn" data-zone="2">Z2</button>
    <button class="zone-btn" data-zone="3">Z3</button>
    <button class="zone-btn" data-zone="4">Z4</button>
    <button class="zone-btn" data-zone="5">Z5</button>
  </div>
  <div class="timer-row">
    <button id="logFeedBtn">Log feed now</button>
    <button id="resetTimerBtn">Reset timer</button>
  </div>
  <div id="timerLine" class="sub-text">No feed logged yet</div>
</div>

<script>
/* ---------------- CONFIG ---------------- */
const NS_URL="https://keithgarvin.us.nightscoutpro.com";
const FUEL_INTERVAL_MIN=20;
const LOW_INTERVAL_MIN=15;

/* ---------------- STATE ---------------- */
let state={
  zone:null,
  bg:null,
  dir:null,
  lastFeed:null,
  low:false,
  lowStart:null
};

/* ---------------- AUDIO + FLASH ---------------- */
let audioCtx=null, audioReady=false;
let lastFuelAlarm=0,lastLowAlarm=0;
const flash=document.getElementById("flashOverlay");

document.addEventListener("click",()=>{
  if(!audioReady){
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    audioReady=true;
  }
},{once:true});

function tripleFlash(){
  [0,180,360].forEach(d=>{
    setTimeout(()=>{
      flash.classList.add("on");
      setTimeout(()=>flash.classList.remove("on"),90);
    },d);
  });
}

function beep(){
  tripleFlash();
  if(!audioReady) return;
  const t=audioCtx.currentTime;
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.type="square";
  o.frequency.setValueAtTime(1100,t);
  g.gain.setValueAtTime(.0001,t);
  g.gain.exponentialRampToValueAtTime(.4,t+.02);
  g.gain.exponentialRampToValueAtTime(.0001,t+.45);
  o.connect(g);g.connect(audioCtx.destination);
  o.start();o.stop(t+.45);
}

/* ---------------- UI ---------------- */
document.querySelectorAll(".zone-btn").forEach(b=>{
  b.onclick=()=>{
    state.zone=+b.dataset.zone;
    document.querySelectorAll(".zone-btn").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    render();
  };
});

logFeedBtn.onclick=()=>{
  state.lastFeed=Date.now();
  lastFuelAlarm=0;
  render();
};

resetTimerBtn.onclick=()=>{
  state.lastFeed=null;
  lastFuelAlarm=0;
  render();
};

/* ---------------- NIGHTSCOUT ---------------- */
async function fetchNS(){
  try{
    const r=await fetch(NS_URL+"/api/v1/entries.json?count=2");
    const d=await r.json();
    const e=d[0];
    state.bg=e.sgv/18;
    state.dir=e.direction;
    render();
  }catch{
    statusLine.textContent="Nightscout error";
  }
}

/* ---------------- LOGIC ---------------- */
function stoplight(bg){
  if(bg<4||bg>10)return"var(--red)";
  if(bg>=6&&bg<=8)return"var(--green)";
  return"var(--amber)";
}

function render(){
  if(state.bg){
    bgValue.textContent=state.bg.toFixed(1);
    bgStrip.style.background=stoplight(state.bg);
  }

  let now=Date.now();
  let remaining=null;
  if(state.lastFeed){
    remaining=FUEL_INTERVAL_MIN-(now-state.lastFeed)/60000;
    timerLine.textContent=remaining>0?
      `Next fuel in ${remaining.toFixed(1)} min`:
      "Fuel due";
  }

  if(state.bg<4){
    feedMain.textContent="STOP — take 15 g fast carbs";
    if(!state.low){
      state.low=true;
      beep();
    }
  }else{
    state.low=false;
    if(remaining!==null&&remaining<=0){
      if(now-lastFuelAlarm>30000){
        beep();
        lastFuelAlarm=now;
      }
      feedMain.textContent="Fuel now";
    }
  }
}

/* ---------------- INIT ---------------- */
fetchNS();
setInterval(fetchNS,60000);
setInterval(render,15000);
</script>
</body>
</html>
