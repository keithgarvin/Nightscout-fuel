<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fuel Helper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-main: #000000;
      --card-bg: #ffffff;
      --card-border: #333;
      --text-main: #000000;
      --accent: #0a84ff;
      /* stoplight palette */
      --red:    #fd0604;
      --amber:  #f6c000;
      --green:  #4af51a;
      --neutral:#ffffff;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 0.7rem;
      background: var(--bg-main);
      color: var(--text-main);
    }

    h1 {
      font-size: 1.1rem;
      margin: 0;
      text-align: center;
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      gap: 0.4rem;
    }

    .top-bar h1 {
      flex: 1;
      text-align: center;
    }

    .icon-btn {
      border: none;
      border-radius: 999px;
      background: #222;
      color: #ccc;
      width: 2.1rem;
      height: 2.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      padding: 0;
    }

    .icon-btn:active {
      background: #444;
    }

    .card {
      border-radius: 0.7rem;
      padding: 0.6rem;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      margin-bottom: 0.45rem;
    }

    .bg-strip {
      border-radius: 0.7rem;
      padding: 0.6rem;
      margin-bottom: 0.5rem;
      text-align: center;
    }

    .bg-value {
      font-size: 2.6rem;
      font-weight: 800;
      margin-bottom: 0.1rem;
    }

    .bg-sub {
      font-size: 1.1rem;
      opacity: 0.85;
    }

    .main-text {
      font-size: 1.6rem;
      text-align: center;
      margin: 0.2rem 0 0.1rem;
      font-weight: 700;
    }

    .sub-text {
      text-align: center;
      font-size: 1.1rem;
      opacity: 0.8;
      margin-bottom: 0.1rem;
    }

    .status-text {
      text-align: center;
      font-size: 1.1rem;
      opacity: 0.7;
    }

    .row {
      display: flex;
      gap: 0.3rem;
      align-items: center;
    }

    .row + .row {
      margin-top: 0.25rem;
    }

    .row > div {
      flex: 1;
    }

    label {
      font-size: 0.75rem;
      opacity: 0.8;
      display: block;
      margin-bottom: 0.15rem;
    }

    input {
      width: 100%;
      padding: 0.35rem;
      border-radius: 0.4rem;
      border: none;
      font-size: 0.9rem;
      box-sizing: border-box;
      background: #222;
      color: #eee;
    }

    .mode-toggle {
      display: flex;
      border-radius: 999px;
      background: #222;
      padding: 0.12rem;
      font-size: 0.85rem;
    }

    .mode-btn {
      flex: 1;
      border: none;
      border-radius: 999px;
      padding: 0.25rem 0.3rem;
      background: transparent;
      color: #aaa;
    }

    .mode-btn.active {
      background: var(--accent);
      color: #fff;
      font-weight: 600;
    }

    .zone-buttons {
      display: flex;
      gap: 0.3rem;
      margin-top: 0.35rem;
    }

    .zone-btn {
      flex: 1;
      border: none;
      border-radius: 0.55rem;
      padding: 0.45rem 0;
      background: #222;
      color: #ccc;
      font-size: 1rem;
      font-weight: 700;
    }

    .zone-btn.active {
      background: var(--accent);
      color: #fff;
    }

    .tiny {
      font-size: 0.7rem;
      opacity: 0.7;
      margin-top: 0.15rem;
      text-align: center;
    }

    .timer-row {
      display: flex;
      gap: 0.4rem;
      margin-top: 0.3rem;
    }

    .timer-row button {
      border: none;
      border-radius: 0.60rem;
      padding: 0.4rem;
      background: #222;
      color: #eee;
      font-size: 0.9rem;
      flex: 1;
    }

    .timer-row button:active {
      background: #444;
    }

    .settings-panel {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease;
    }

    .settings-panel.open {
      max-height: 500px;
    }

    .settings-caption {
      font-size: 0.75rem;
      opacity: 0.75;
      margin-top: 0.2rem;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <button class="icon-btn" id="refreshBtn">⭮</button>
    <h1>Fuel Helper</h1>
    <button class="icon-btn" id="settingsToggle">⚙︎</button>
  </div>

  <!-- BG strip with stoplight colours -->
  <div id="bgStrip" class="bg-strip" style="background:var(--neutral);">
    <div id="bgValue" class="bg-value">--.--</div>
    <div id="bgSub" class="bg-sub">Waiting for CGM…</div>
  </div>

  <!-- Main fueling summary -->
  <div class="card">
    <div id="feedMain" class="main-text">Set zone to begin</div>
    <div id="feedSub" class="sub-text"></div>
    <div id="projLine" class="sub-text"></div>
    <div id="statusLine" class="status-text">Nightscout: idle</div>
  </div>

  <!-- Zone + timer card -->
  <div class="card">
    <div id="zoneLine" class="sub-text">Zone --</div>

    <div class="zone-buttons">
      <button class="zone-btn" data-zone="1">Z1</button>
      <button class="zone-btn" data-zone="2">Z2</button>
      <button class="zone-btn" data-zone="3">Z3</button>
      <button class="zone-btn" data-zone="4">Z4</button>
      <button class="zone-btn" data-zone="5">Z5</button>
    </div>

    <div class="timer-row">
      <button id="logFeedBtn">Log feed now</button>
      <button id="resetTimerBtn">Reset timer</button>
    </div>
    <div class="tiny" id="timerLine">No feed logged yet</div>
  </div>

  <!-- Slide-down settings -->
  <div class="card settings-panel" id="settingsPanel">
    <div class="row">
      <div>
        <label for="ftpInput">FTP (watts)</label>
        <input id="ftpInput" type="number" inputmode="numeric" value="305" />
      </div>
      <div>
        <label>BG units</label>
        <button id="unitToggle" class="mode-btn active" style="width:100%; border-radius:0.4rem;">mmol/L</button>
      </div>
    </div>

    <div style="margin-top:0.4rem;">
      <label>Mode</label>
      <div class="mode-toggle">
        <button class="mode-btn active" data-mode="training" id="modeTraining">Training</button>
        <button class="mode-btn" data-mode="race" id="modeRace">Race</button>
      </div>
    </div>

    <div style="margin-top:0.4rem;">
      <label>Training carbs per 20 min (g)</label>
      <div class="row">
        <div>
          <label for="trainZ1">Z1</label>
          <input id="trainZ1" type="number" />
        </div>
        <div>
          <label for="trainZ2">Z2</label>
          <input id="trainZ2" type="number" />
        </div>
        <div>
          <label for="trainZ3">Z3</label>
          <input id="trainZ3" type="number" />
        </div>
        <div>
          <label for="trainZ4">Z4</label>
          <input id="trainZ4" type="number" />
        </div>
        <div>
          <label for="trainZ5">Z5</label>
          <input id="trainZ5" type="number" />
        </div>
      </div>
    </div>

    <div style="margin-top:0.4rem;">
      <label>Race carbs per 20 min (g)</label>
      <div class="row">
        <div>
          <label for="raceZ1">Z1</label>
          <input id="raceZ1" type="number" />
        </div>
        <div>
          <label for="raceZ2">Z2</label>
          <input id="raceZ2" type="number" />
        </div>
        <div>
          <label for="raceZ3">Z3</label>
          <input id="raceZ3" type="number" />
        </div>
        <div>
          <label for="raceZ4">Z4</label>
          <input id="raceZ4" type="number" />
        </div>
        <div>
          <label for="raceZ5">Z5</label>
          <input id="raceZ5" type="number" />
        </div>
      </div>
    </div>

    <div class="settings-caption">
      Defaults – Training (per 20'): 10, 15, 20, 25, 30 g (Z1–Z5).  
      Race: 15, 20, 25, 30, 35 g. Adjust here then close this panel.
    </div>
  </div>

  <script>
    // ----- CONSTANTS -----
    const NS_URL = "https://keithgarvin.us.nightscoutpro.com";
    const FUEL_INTERVAL_MIN = 20;
const LOW_INTERVAL_MIN = 15; // your 15-minute wait

// Base carb targets in g/hour by zone (Z1–Z5), based on physiology
const TRAINING_G_PER_HR = [30, 45, 60, 75, 90];
const RACE_G_PER_HR     = [45, 60, 75, 90, 105];

// Convert g/hr to g per fueling interval (20 min)
function computeDefaultCarbsFromHr(arrGPerHr) {
  return arrGPerHr.map(v => Math.round(v * (FUEL_INTERVAL_MIN / 60)));
}

const DEFAULT_TRAINING = computeDefaultCarbsFromHr(TRAINING_G_PER_HR);
const DEFAULT_RACE     = computeDefaultCarbsFromHr(RACE_G_PER_HR);
    // ----- STATE -----
    let state = {
      useMmol: true,
      mode: "training",
      currentZone: null,
      lastBgMmol: null,
      lastDirection: null,
      lastDateMs: null,
      lastFeedTime: null,
      projBg20_mg: null,
      lowActive: false,
      lowStartTime: null,
      lowRecoveredRecently: false,
      lowRecoverTime: null
    };

    // ----- ELEMENTS -----
    const bgStrip = document.getElementById('bgStrip');
    const bgValue = document.getElementById('bgValue');
    const bgSub = document.getElementById('bgSub');

    const feedMain = document.getElementById('feedMain');
    const feedSub = document.getElementById('feedSub');
    const projLine = document.getElementById('projLine');
    const statusLine = document.getElementById('statusLine');
    const zoneLine = document.getElementById('zoneLine');
    const timerLine = document.getElementById('timerLine');

    const settingsPanel = document.getElementById('settingsPanel');
    const settingsToggle = document.getElementById('settingsToggle');
    const refreshBtn = document.getElementById('refreshBtn');

    const modeTrainingBtn = document.getElementById('modeTraining');
    const modeRaceBtn = document.getElementById('modeRace');
    const unitToggle = document.getElementById('unitToggle');

    const ftpInput = document.getElementById('ftpInput');

    const trainInputs = [
      document.getElementById('trainZ1'),
      document.getElementById('trainZ2'),
      document.getElementById('trainZ3'),
      document.getElementById('trainZ4'),
      document.getElementById('trainZ5')
    ];
    const raceInputs = [
      document.getElementById('raceZ1'),
      document.getElementById('raceZ2'),
      document.getElementById('raceZ3'),
      document.getElementById('raceZ4'),
      document.getElementById('raceZ5')
    ];

    const zoneButtons = Array.from(document.querySelectorAll('.zone-btn'));
    const logFeedBtn = document.getElementById('logFeedBtn');
    const resetTimerBtn = document.getElementById('resetTimerBtn');

    // ----- SETTINGS STORAGE -----
    function loadSettings() {
      try {
        const saved = JSON.parse(localStorage.getItem('nsFuelSettingsV3') || '{}');

        if (saved.ftp) ftpInput.value = saved.ftp;

        if (typeof saved.useMmol === 'boolean') {
          state.useMmol = saved.useMmol;
        }
        unitToggle.textContent = state.useMmol ? 'mmol/L' : 'mg/dL';
        unitToggle.classList.toggle('active', state.useMmol);

        if (saved.mode === 'race' || saved.mode === 'training') {
          state.mode = saved.mode;
        }

        state.trainingCarbs = Array.isArray(saved.trainingCarbs) && saved.trainingCarbs.length === 5
          ? saved.trainingCarbs
          : DEFAULT_TRAINING.slice();

        state.raceCarbs = Array.isArray(saved.raceCarbs) && saved.raceCarbs.length === 5
          ? saved.raceCarbs
          : DEFAULT_RACE.slice();
      } catch (e) {
        state.trainingCarbs = DEFAULT_TRAINING.slice();
        state.raceCarbs = DEFAULT_RACE.slice();
      }

      // fill inputs based on stored arrays
      state.trainingCarbs.forEach((v, i) => { if (trainInputs[i]) trainInputs[i].value = v; });
      state.raceCarbs.forEach((v, i) => { if (raceInputs[i]) raceInputs[i].value = v; });

      updateModeButtons();
    }

    function saveSettings() {
      const settings = {
        ftp: Number(ftpInput.value) || null,
        useMmol: state.useMmol,
        mode: state.mode,
        trainingCarbs: state.trainingCarbs,
        raceCarbs: state.raceCarbs
      };
      localStorage.setItem('nsFuelSettingsV3', JSON.stringify(settings));
    }

    function updateCarbArraysFromInputs() {
      state.trainingCarbs = trainInputs.map(inp => Number(inp.value) || 0);
      state.raceCarbs = raceInputs.map(inp => Number(inp.value) || 0);
      saveSettings();
      render();
    }

    trainInputs.forEach(inp => inp.addEventListener('change', updateCarbArraysFromInputs));
    raceInputs.forEach(inp => inp.addEventListener('change', updateCarbArraysFromInputs));
    ftpInput.addEventListener('change', saveSettings);

    // ----- UNIT TOGGLE -----
    unitToggle.addEventListener('click', () => {
      state.useMmol = !state.useMmol;
      unitToggle.textContent = state.useMmol ? 'mmol/L' : 'mg/dL';
      unitToggle.classList.toggle('active', state.useMmol);
      saveSettings();
      render();
    });

    // ----- MODE TOGGLE -----
    function setMode(mode) {
      state.mode = mode;
      updateModeButtons();
      saveSettings();
      render();
    }

    function updateModeButtons() {
      if (state.mode === 'training') {
        modeTrainingBtn.classList.add('active');
        modeRaceBtn.classList.remove('active');
      } else {
        modeTrainingBtn.classList.remove('active');
        modeRaceBtn.classList.add('active');
      }
    }

    modeTrainingBtn.addEventListener('click', () => setMode('training'));
    modeRaceBtn.addEventListener('click', () => setMode('race'));

    // ----- SETTINGS PANEL -----
    settingsToggle.addEventListener('click', () => {
      settingsPanel.classList.toggle('open');
    });

    // ----- ZONES -----
    function setZone(z) {
      state.currentZone = z;
      zoneButtons.forEach(btn => {
        const bz = Number(btn.dataset.zone);
        btn.classList.toggle('active', bz === z);
      });
      render();
    }

    zoneButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const z = Number(btn.dataset.zone);
        setZone(z);
      });
    });

    // ----- NIGHTSCOUT FETCH -----
    async function fetchNightscout() {
      const base = NS_URL;
      if (!base) {
        statusLine.textContent = 'Nightscout URL not set';
        return;
      }
      const url = base.replace(/\/+$/, '') + '/api/v1/entries.json?count=4';

      statusLine.textContent = 'Refreshing from Nightscout…';

      try {
        const res = await fetch(url);
        if (!res.ok) {
          statusLine.textContent = 'Nightscout error: ' + res.status;
          return;
        }
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) {
          statusLine.textContent = 'No data from Nightscout';
          return;
        }

        const entry = data[0];
        const sgv = Number(entry.sgv); // mg/dL from Nightscout/Dexcom
        const direction = entry.direction || '';
        const dateMs = entry.date || entry.dateString;

        if (!Number.isFinite(sgv) || !dateMs) {
          statusLine.textContent = 'Invalid Nightscout entry';
          return;
        }

        const bgMmol = sgv / 18.0;

        state.lastBgMmol = bgMmol;
        state.lastDirection = direction;
        state.lastDateMs = typeof dateMs === 'number' ? dateMs : Date.parse(dateMs);

        computeProjection(data);

        statusLine.textContent = 'Nightscout: OK';
        render();
      } catch (e) {
        console.log(e);
        statusLine.textContent = 'Error talking to Nightscout';
      }
    }

    refreshBtn.addEventListener('click', fetchNightscout);

    // ----- TIMING / FEED TIMER -----
    logFeedBtn.addEventListener('click', () => {
      state.lastFeedTime = Date.now();
      render();
    });

    resetTimerBtn.addEventListener('click', () => {
      state.lastFeedTime = null;
      render();
    });

    function getFeedTimerText() {
      const now = Date.now();

      // Low protocol timer overrides fueling timer
      if (state.lowActive && state.lowStartTime) {
        const diffMin = (now - state.lowStartTime) / 60000;
        const remaining = LOW_INTERVAL_MIN - diffMin;
        if (remaining > 0) {
          return `Low protocol active • Re-check in: ${remaining.toFixed(1)} min`;
        } else {
          return 'Low protocol: re-check window active.';
        }
      }

      if (!state.lastFeedTime) {
        return 'No feed logged yet';
      }
      const diffMin = (now - state.lastFeedTime) / 60000;
      const since = diffMin < 1 ? '<1 min ago' : diffMin.toFixed(1) + ' min ago';
      const remaining = FUEL_INTERVAL_MIN - diffMin;

      if (remaining <= 0) {
        return `Fuel window active • Last fuel: ${since}`;
      } else {
        return `Next fuel in: ${remaining.toFixed(1)} min • Last fuel: ${since}`;
      }
    }

    // ----- PROJECTION (simple linear estimate) -----
    function computeProjection(entries) {
      state.projBg20_mg = null;

      if (!Array.isArray(entries) || entries.length < 2) return;

      const sorted = entries.slice().sort((a, b) => {
        const ta = a.date || Date.parse(a.dateString);
        const tb = b.date || Date.parse(b.dateString);
        return tb - ta;
      });

      const newest = sorted[0];
      const oldest = sorted[sorted.length - 1];

      const sgvNew = Number(newest.sgv);
      const sgvOld = Number(oldest.sgv);
      const tNew = newest.date || Date.parse(newest.dateString);
      const tOld = oldest.date || Date.parse(oldest.dateString);

      if (!Number.isFinite(sgvNew) || !Number.isFinite(sgvOld) || !tNew || !tOld) return;

      const dtMin = (tNew - tOld) / 60000;
      if (dtMin <= 0.5) return;

      const slopeMgPerMin = (sgvNew - sgvOld) / dtMin;
      const horizonMin = 20;
      const projMg = sgvNew + slopeMgPerMin * horizonMin;
      state.projBg20_mg = projMg;
    }

    // ----- FUELING / LOW STATE -----
    function updateLowState(bgMmol) {
      const now = Date.now();
      if (bgMmol == null) return;

      if (bgMmol < 4.0) {
        if (!state.lowActive) {
          state.lowActive = true;
          state.lowStartTime = now;
          state.lowRecoveredRecently = false;
          state.lowRecoverTime = null;
        }
      } else {
        if (state.lowActive) {
          state.lowActive = false;
          state.lowRecoveredRecently = true;
          state.lowRecoverTime = now;
        }
        if (state.lowRecoveredRecently && state.lowRecoverTime) {
          const sinceRecoverMin = (now - state.lowRecoverTime) / 60000;
          // after 5 minutes, stop showing "recovered" and go back to normal wording
          if (sinceRecoverMin > 5) {
            state.lowRecoveredRecently = false;
          }
        }
      }
    }

    function isFalling(dir) {
      return dir === 'FortyFiveDown' || dir === 'SingleDown';
    }
    function isFallingFast(dir) {
      return dir === 'DoubleDown';
    }
    function isRising(dir) {
      return dir === 'FortyFiveUp' || dir === 'SingleUp';
    }
    function isRisingFast(dir) {
      return dir === 'DoubleUp';
    }

    function getTrendSymbol(direction) {
      switch (direction) {
        case 'DoubleUp':      return '↑↑';
        case 'SingleUp':      return '↑';
        case 'FortyFiveUp':   return '↗';
        case 'Flat':          return '→';
        case 'FortyFiveDown': return '↘';
        case 'SingleDown':    return '↓';
        case 'DoubleDown':    return '↓↓';
        default:              return '';
      }
    }

    function getCarbsPerZone() {
      return state.mode === 'race' ? state.raceCarbs : state.trainingCarbs;
    }

    function getFuelInstruction(bgMmol, direction, zone, carbsZ, ageMin) {
      const dir = direction || '';

      // Low protocol
      if (state.lowActive && bgMmol != null && bgMmol < 4.0) {
        return 'Stop cycling and dose 15 g fast carbs. Wait 15 minutes and re-dose if necessary.';
      }

      // Recovery message after a low
      if (!state.lowActive && state.lowRecoveredRecently && bgMmol != null && bgMmol >= 4.0) {
        return 'BG recovered — resume cycling and fueling.';
      }

      if (bgMmol == null || !zone) return 'Set zone to see fueling';

      if (ageMin != null && ageMin > 10) {
        return 'Data old — check CGM';
      }

      const base = carbsZ[zone - 1] || 0;
      const baseStr = `${base} g per ${FUEL_INTERVAL_MIN} min`;

      // 4.0–6.0
      if (bgMmol >= 4.0 && bgMmol < 6.0) {
        if (isFallingFast(dir)) {
          const extra = base + 10;
          return `Fuel: ${extra} g per ${FUEL_INTERVAL_MIN} min (falling fast)`;
        } else if (isFalling(dir)) {
          const extra = base + 5;
          return `Fuel: ${extra} g per ${FUEL_INTERVAL_MIN} min (falling)`;
        } else {
          return `Fuel: ${baseStr} (stable)`;
        }
      }

      // 6.0–8.0 (sweet spot)
      if (bgMmol >= 6.0 && bgMmol <= 8.0) {
        if (isRisingFast(dir)) {
          const trimmed = Math.max(0, base - 5);
          return `Fuel: ${trimmed} g per ${FUEL_INTERVAL_MIN} min (rising fast)`;
        }
        return `Fuel: ${baseStr}`;
      }

      // 8.0–10.0
      if (bgMmol > 8.0 && bgMmol <= 10.0) {
        if (isRising(dir) || isRisingFast(dir)) {
          return 'Hold fuel (BG elevated, rising)';
        } else if (zone >= 4) {
          return `Fuel: ${baseStr} (high intensity)`;
        } else {
          return 'Hold fuel (BG elevated)';
        }
      }

      // > 10.0
      if (bgMmol > 10.0) {
        return 'BG high — ride fueling suspended. Follow your plan.';
      }

      return '---';
    }

    function bgStoplightColor(bgMmol) {
      if (bgMmol == null) return 'var(--neutral)';
      if (bgMmol < 4.0 || bgMmol > 10.0) return 'var(--red)';
      if (bgMmol >= 6.0 && bgMmol <= 8.0) return 'var(--green)';
      // 4–6 or 8–10
      return 'var(--amber)';
    }

    // ----- RENDER -----
    function render() {
      const bgMmol = state.lastBgMmol;
      const dir = state.lastDirection;
      const zone = state.currentZone;
      const carbsZ = getCarbsPerZone();

      updateLowState(bgMmol);

      // BG strip
      if (bgMmol == null) {
        bgValue.textContent = '--.--';
        bgSub.textContent = 'Waiting for CGM…';
        bgStrip.style.background = 'var(--neutral)';
      } else {
        const sym = getTrendSymbol(dir);
        if (state.useMmol) {
          bgValue.textContent = bgMmol.toFixed(1) + ' ' + sym;
          bgSub.textContent = 'mmol/L';
        } else {
          const bgMg = bgMmol * 18.0;
          bgValue.textContent = bgMg.toFixed(0) + ' ' + sym;
          bgSub.textContent = 'mg/dL';
        }
        bgStrip.style.background = bgStoplightColor(bgMmol);
      }

      // Zone text
      if (!zone) {
        zoneLine.textContent = 'Zone --';
      } else {
        const ftp = Number(ftpInput.value) || null;
        let zoneTxt = 'Zone ' + zone;
        if (ftp) {
          const pctRanges = [
            [0, 0.55],
            [0.55, 0.75],
            [0.75, 0.90],
            [0.90, 1.05],
            [1.05, 1.20]
          ];
          const r = pctRanges[zone - 1] || null;
          if (r) {
            const low = Math.round(ftp * r[0]);
            const high = Math.round(ftp * r[1]);
            zoneTxt += ` (~${low}-${high}W)`;
          }
        }
        zoneLine.textContent = `${zoneTxt} • ${state.mode === 'race' ? 'Race' : 'Training'} plan`;
      }

      // CGM age
      let ageMin = null;
      if (state.lastDateMs) {
        const ageMs = Date.now() - state.lastDateMs;
        ageMin = ageMs / 60000;
        const ageStr = ageMin < 1 ? '<1 min ago' : ageMin.toFixed(1) + ' min ago';
        feedSub.textContent = 'Last CGM: ' + ageStr;
      } else {
        feedSub.textContent = '';
      }

      // Fuel instruction
      const fuelText = getFuelInstruction(bgMmol, dir, zone, carbsZ, ageMin);
      feedMain.textContent = fuelText;

      // Projection line (neutral info only)
      if (state.projBg20_mg != null && state.useMmol) {
        const projMmol = state.projBg20_mg / 18.0;
        projLine.textContent = `Projected ~${FUEL_INTERVAL_MIN} min BG (linear): ${projMmol.toFixed(1)} mmol/L`;
      } else if (state.projBg20_mg != null && !state.useMmol) {
        projLine.textContent = `Projected ~${FUEL_INTERVAL_MIN} min BG (linear): ${state.projBg20_mg.toFixed(0)} mg/dL`;
      } else {
        projLine.textContent = '';
      }

      // Timer text
      timerLine.textContent = getFeedTimerText();
    }

    // ----- INIT -----
    loadSettings();
    render();
    fetchNightscout();
    setInterval(fetchNightscout, 60000);
    setInterval(render, 15000);
  </script>
</body>
</html>










